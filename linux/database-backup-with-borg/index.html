<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.14.2 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Create daily database backups with Borg - BLOG.GAINANOV.PRO</title>
<meta name="description" content="This article shows how to create backups of your data from PostgreSQL DB to a remote server with a secure and effective approach">



<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="BLOG.GAINANOV.PRO">
<meta property="og:title" content="Create daily database backups with Borg">
<meta property="og:url" content="https://gainanovrus.github.io/blog/linux/database-backup-with-borg/">


  <meta property="og:description" content="This article shows how to create backups of your data from PostgreSQL DB to a remote server with a secure and effective approach">





  <meta name="twitter:site" content="@gainanovrus">
  <meta name="twitter:title" content="Create daily database backups with Borg">
  <meta name="twitter:description" content="This article shows how to create backups of your data from PostgreSQL DB to a remote server with a secure and effective approach">
  <meta name="twitter:url" content="https://gainanovrus.github.io/blog/linux/database-backup-with-borg/">

  
    <meta name="twitter:card" content="summary">
    
  

  



  <meta property="article:published_time" content="2018-04-15T00:00:00+03:00">





  

  


<link rel="canonical" href="https://gainanovrus.github.io/blog/linux/database-backup-with-borg/">







  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Person",
      "name": "Ruslan Gainanov",
      "url": "https://gainanovrus.github.io/blog",
      "sameAs": ["https://www.facebook.com/gainanovrus","https://twitter.com/gainanovrus","https://linkedin.com/in/gainanovrus"]
    }
  </script>



  <meta name="google-site-verification" content="Wq8i7X_W6EpXbttUnWRWiok4EyvFVb-nyUaY_kDLDMc" />




  <meta name="yandex-verification" content="cfbcdd4107182b42">


<!-- end _includes/seo.html -->


<link href="/blog/feed.xml" type="application/atom+xml" rel="alternate" title="BLOG.GAINANOV.PRO Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/blog/assets/css/main.css">

<!--[if IE ]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->


  
    
    <script src="/blog/assets/js/buttons.js"></script>
  


    <!-- start custom head snippets -->
<!-- <link href="/assets/css/tagcloud04.css" rel="stylesheet" type="text/css"> -->
<link href="https://gainanovrus.github.io/favicon.ico" rel="icon" type="image/x-icon" />

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-115465350-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-115465350-1');
</script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
    (function (d, w, c) {
        (w[c] = w[c] || []).push(function() {
            try {
                w.yaCounter50010985 = new Ya.Metrika2({
                    id:50010985,
                    clickmap:true,
                    trackLinks:true,
                    accurateTrackBounce:true
                });
            } catch(e) { }
        });

        var n = d.getElementsByTagName("script")[0],
            s = d.createElement("script"),
            f = function () { n.parentNode.insertBefore(s, n); };
        s.type = "text/javascript";
        s.async = true;
        s.src = "https://mc.yandex.ru/metrika/tag.js";

        if (w.opera == "[object Opera]") {
            d.addEventListener("DOMContentLoaded", f, false);
        } else { f(); }
    })(document, window, "yandex_metrika_callbacks2");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/50010985" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    <div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        <a class="site-title" href="/blog/">BLOG.GAINANOV.PRO</a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/blog/categories/" >Categories</a>
            </li><li class="masthead__menu-item">
              <a href="/blog/tags/" >Tags</a>
            </li><li class="masthead__menu-item">
              <a href="/blog/portfolio/" >Portfolio</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.99 16">
            <path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z" transform="translate(-.01)"></path>
          </svg>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      

      
        <img src="/blog/assets/images/author-150x150.jpg" alt="Ruslan Gainanov" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Ruslan Gainanov</h3>
    
    
      <p class="author__bio" itemprop="description">
        System & Software engineer
      </p>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      

      
        
          
        
          
        
          
        
          
        
          
        
          
        
      

      
        <li>
          <a href="http://gainanov.pro" itemprop="url">
            <i class="fas fa-fw fa-link" aria-hidden="true"></i> Website
          </a>
        </li>
      

      
        <li>
          <a href="mailto:gromrx1@gmail.com">
            <meta itemprop="email" content="gromrx1@gmail.com" />
            <i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i> Email
          </a>
        </li>
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
      

      

    </ul>
  </div>
</div>

  
  </div>


  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Create daily database backups with Borg">
    <meta itemprop="description" content="This article shows how to create backups of your data from PostgreSQL DB to a remote server with a secure and effective approach">
    <meta itemprop="datePublished" content="April 15, 2018">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Create daily database backups with Borg
</h1>
          
            <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  6 minute read
</p>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right ">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> On this page</h4></header>
              <ul class="toc__menu">
  <li><a href="#prerequisites">Prerequisites</a></li>
  <li><a href="#instructions">Instructions</a>
    <ul>
      <li><a href="#install-borg-on-both-servers">Install borg on both servers</a></li>
      <li><a href="#configure-access-to-the-backup-server">Configure access to the backup server</a></li>
      <li><a href="#create-a-backup-script">Create a backup script</a>
        <ul>
          <li><a href="#borgbackup-command">BorgBackup command</a></li>
          <li><a href="#borgmatic-settings">Borgmatic settings</a></li>
        </ul>
      </li>
      <li><a href="#create-a-passphrase-on-the-database-server">Create a passphrase on the database server</a></li>
      <li><a href="#create-a-repository-on-the-backup-server">Create a repository on the backup server</a></li>
      <li><a href="#create-a-deamon-to-automate-running-a-backup-script">Create a deamon to automate running a backup script</a></li>
      <li><a href="#manual-run-script-and-view-logs">Manual run script and view logs</a></li>
      <li><a href="#finish-preparations-and-check-the-results">Finish preparations and check the results</a></li>
    </ul>
  </li>
  <li><a href="#additional-information">Additional information:</a></li>
</ul>
            </nav>
          </aside>
        
        <p>In this post, I want to describe a creating backup of PostgreSQL database and transferring it to a remote server. I will show you how to automate it to get regular daily backup and use a deduplication tool as <a href="https://borgbackup.readthedocs.io/en/stable/index.html">Borgbackup</a> for effective using storage. Also, the tool has methods for encryption your data and I will show how to use it. 
Backup database to borg repository is the efficient and secure way to store your critically important data.</p>

<h2 id="prerequisites">Prerequisites</h2>

<p>Before following this tutorial, you should understand conditions that I have:</p>
<ul>
  <li>Has two Linux servers:
    <ul>
      <li>one is a backup remote storage</li>
      <li>second is a database server</li>
    </ul>
  </li>
</ul>

<p>I will use Centos 7 on the remote server, and Ubuntu 16.04 on another server with installed PostgreSQL 9.6. They both have connections to one network, an IP of Centos is 192.168.0.1 and Ubuntu has 192.168.0.2. Backup server has a special backup user with name <code class="highlighter-rouge">backup_user</code></p>

<h2 id="instructions">Instructions</h2>

<h3 id="install-borg-on-both-servers">Install borg on both servers</h3>

<p>Is a simple action just use apt or yum install:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apt install borgbackup
</code></pre></div></div>

<p>And checking your version after that <code class="highlighter-rouge">borg --version</code>.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Centos: borg 1.1.4
Ubuntu: borg 1.0.11
</code></pre></div></div>

<p>Ok, some differences can’t a problem with using it. If you want to use the last version follow <a href="https://borgbackup.readthedocs.io/en/stable/installation.html">this</a> installing instruction. But didn’t use the version before 1.0.9 because that has a <a href="https://borgbackup.readthedocs.io/en/stable/changes.html#pre-1-0-9-manifest-spoofing-vulnerability-cve-2016-10099">vulnerability</a>.</p>

<p>Official docs have a good description of basic usage a borg commands and options,  see them for best understanding next commands.</p>

<h3 id="configure-access-to-the-backup-server">Configure access to the backup server</h3>

<p>Generate ssh key to remote access to the backup server if you don’t get it.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh-keygen -b 2048 -t rsa -q -N '' -f ~/.ssh/id_rsa
</code></pre></div></div>

<p>Create a config file if you don’t want to remember an IP of the remote server like me.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cat &lt;&lt; EOT &gt;&gt; ~/.ssh/config
Host backup_server
User backup_user
HostName 192.168.0.1
Port 22
EOT
</code></pre></div></div>

<p>And run command to copy generated public key to the remote server.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh-copy-id backup_server
</code></pre></div></div>

<p>Test it.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># ssh backup_server
Last login: Sun Apr 15 10:18:16 2018
[backup_user@backup_server ~]$
</code></pre></div></div>

<p>All is OK.</p>

<h3 id="create-a-backup-script">Create a backup script</h3>

<p>Ok, let’s begin to automate the process of creating a backup of the database. I am using a <a href="https://www.postgresql.org/docs/current/static/app-pg-dumpall.html"><code class="highlighter-rouge">pg_dumpall</code></a> to create a backup of a full database. A result of this command a SQL-file that can create all existing databases and users in a new place. This result before coping will been stored on local path <code class="highlighter-rouge">/root/db_dumps</code>. Also I make backup of database configs.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="nv">BACKUP_DIR</span><span class="o">=</span>/root/db_dumps
<span class="nv">BACKUP_DUMP_NAME</span><span class="o">=</span><span class="s2">"dump_</span><span class="k">$(</span><span class="nb">date</span> <span class="s1">'+%Y-%m-%d_%H%M%S'</span><span class="k">)</span><span class="s2">.sql"</span>
<span class="nv">BACKUP_CONFIG_NAME</span><span class="o">=</span><span class="s2">"config_</span><span class="k">$(</span><span class="nb">date</span> <span class="s1">'+%Y-%m-%d_%H%M%S'</span><span class="k">)</span><span class="s2">.tar.gz"</span>
<span class="nv">USERNAME</span><span class="o">=</span>postgres
<span class="nv">BORG_CMD</span><span class="o">=</span><span class="s2">"borgmatic"</span>
<span class="nv">DB_CONF_PATH</span><span class="o">=</span><span class="s2">"/etc/postgresql/9.6/main"</span>

error_exit<span class="o">()</span>
<span class="o">{</span>
  <span class="nb">echo</span> <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> 1&gt;&amp;2
  <span class="nb">exit </span>1
<span class="o">}</span>

debug_message<span class="o">()</span>
<span class="o">{</span>
    <span class="nb">echo</span> <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> 1&gt;&amp;2
<span class="o">}</span>

debug_message <span class="s2">"[backup][START] Start creating backup"</span>

<span class="c">#remove previous backup</span>
<span class="o">[[</span> <span class="nt">-d</span> <span class="k">${</span><span class="nv">BACKUP_DIR</span><span class="k">}</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span>  <span class="nb">rm</span> <span class="nt">-rf</span> <span class="k">${</span><span class="nv">BACKUP_DIR</span><span class="k">}</span>
<span class="o">[[</span> <span class="o">!</span> <span class="nt">-d</span> <span class="k">${</span><span class="nv">BACKUP_DIR</span><span class="k">}</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nb">mkdir</span> <span class="k">${</span><span class="nv">BACKUP_DIR</span><span class="k">}</span> <span class="o">&amp;&amp;</span> <span class="nb">chmod </span>700 <span class="k">${</span><span class="nv">BACKUP_DIR</span><span class="k">}</span>

<span class="c">#backup database data</span>
<span class="nb">cd</span> <span class="k">${</span><span class="nv">BACKUP_DIR</span><span class="k">}</span>
<span class="k">if</span> <span class="o">!</span> pg_dumpall <span class="nt">-U</span> <span class="s2">"</span><span class="nv">$USERNAME</span><span class="s2">"</span> <span class="nt">--file</span><span class="o">=</span><span class="k">${</span><span class="nv">BACKUP_DUMP_NAME</span><span class="k">}</span><span class="p">;</span> <span class="k">then
  </span>error_exit <span class="s2">"[backup][ERROR] Failed to produce data backup"</span>
<span class="k">else
  </span>debug_message <span class="s2">"[backup][SUCCESS] Data backup success created"</span>
<span class="k">fi</span>

<span class="c">#backup database configures</span>
<span class="nb">cd</span> <span class="k">${</span><span class="nv">DB_CONF_PATH</span><span class="k">}</span>
<span class="k">if</span> <span class="o">!</span> <span class="nb">tar</span> <span class="nt">-cvzf</span> <span class="k">${</span><span class="nv">BACKUP_CONFIG_NAME</span><span class="k">}</span> <span class="k">*</span>.conf <span class="o">&gt;</span> /dev/null 2&gt;&amp;1<span class="p">;</span> <span class="k">then
  </span>error_exit <span class="s2">"[backup][ERROR] Cannot create archive with PG conf files"</span>
<span class="k">else</span>
  <span class="o">[[</span> <span class="nt">-f</span> <span class="k">${</span><span class="nv">BACKUP_CONFIG_NAME</span><span class="k">}</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span>  <span class="nb">mv</span> <span class="k">${</span><span class="nv">BACKUP_CONFIG_NAME</span><span class="k">}</span> <span class="k">${</span><span class="nv">BACKUP_DIR</span><span class="k">}</span>
  debug_message <span class="s2">"[backup][SUCCESS] Config files success created"</span>
<span class="k">fi</span>

<span class="c">#copy to backup server</span>
<span class="k">if</span> <span class="o">!</span> <span class="k">${</span><span class="nv">BORG_CMD</span><span class="k">}</span> <span class="p">;</span> <span class="k">then
  </span>error_exit <span class="s2">"[backup][ERROR] Failed copy to backup server"</span>
<span class="k">else
  </span>debug_message <span class="s2">"[backup][SUCCESS] Data backup success copied"</span>
<span class="k">fi</span>


<span class="c">#remove local backup files</span>
<span class="c">#none</span>

debug_message <span class="s2">"[backup][COMPLETE] Backup success created"</span>
</code></pre></div></div>

<p>I saved this script in the database server by path <code class="highlighter-rouge">/opt/postgres_backup.sh</code>. And set execute rights to file (<code class="highlighter-rouge">chmod 700 /opt/postgres_backup.sh</code>).</p>

<h4 id="borgbackup-command">BorgBackup command</h4>

<p>In my script has been a variable <code class="highlighter-rouge">BORG_CMD</code> is a wrapper of Borgbackup - <a href="https://torsion.org/borgmatic/"><code class="highlighter-rouge">borgmatic</code></a>. It initiates a backup, prunes any old backups according to a retention policy, and validates backups for consistency. The script supports specifying your settings in a declarative configuration file rather than having to put them all on the command-line and handles common errors.</p>

<p>To install <code class="highlighter-rouge">borgmatic</code> use pip3:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pip3 install --upgrade borgmatic
</code></pre></div></div>

<h4 id="borgmatic-settings">Borgmatic settings</h4>

<p>The settings of borgmatic is stored on <code class="highlighter-rouge">/etc/borgmatic/config.yaml</code>. And my ones to our task are described below.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>location:
    source_directories:
        - /root/db_dumps

    repositories:
        - backup_server:/backups/db

storage:
    encryption_passcommand: "cat /root/.borg-passphrase"

retention:
    keep_daily: 30
    keep_weekly: 12
    keep_monthly: 6

consistency:
    checks:
        - repository
        - archives
    check_last: 7
</code></pre></div></div>

<h3 id="create-a-passphrase-on-the-database-server">Create a passphrase on the database server</h3>

<p>Next command creating a key file to use as a passphrase of an encrypted repository. Borg are using system environments to get some parameters. This one show borg how to get a passphrase to either new or existing repository.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>head -c 1024 /dev/urandom | base64 &gt; /root/.borg-passphrase
chmod 400 /root/.borg-passphrase
export BORG_PASSCOMMAND="cat /root/.borg-passphrase"
</code></pre></div></div>

<h3 id="create-a-repository-on-the-backup-server">Create a repository on the backup server</h3>

<p>Using a <code class="highlighter-rouge">repokey</code> modes to “passphrase-only” security. The key will be stored inside the repository (in its “config” file). In above mentioned attack scenario, the attacker will have the key (but not the passphrase).</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># borg init --encryption=repokey backup_server:/backups/db

By default repositories initialized with this version will produce security
errors if written to with an older version (up to and including Borg 1.0.8).

If you want to use these older versions, you can disable the check by running:
borg upgrade --disable-tam db_test

See https://borgbackup.readthedocs.io/en/stable/changes.html#pre-1-0-9-manifest-spoofing-vulnerability for details about the security implications.
</code></pre></div></div>

<p>The output has some warnings about a using old version.</p>

<h3 id="create-a-deamon-to-automate-running-a-backup-script">Create a deamon to automate running a backup script</h3>

<p>Ubuntu has a nice mechanism to auto-running scripts or applications in the background. His name - <code class="highlighter-rouge">SystemD</code>. And if exists a necessity to run a script by a scheduler (i.e. every night) you should use timers that is part of systemd.</p>

<p>I write my own daemon  to run an above script. It has stored on <code class="highlighter-rouge">/etc/systemd/system/backup.service</code>.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[Unit]
Description=Backup PostgreSQL database

[Service]
Type=oneshot
ExecStart=/bin/bash /opt/postgres_backup.sh
</code></pre></div></div>

<p>And I has a timer unit that runs a backup.service every day at midnight</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[Unit]
Description=Run backup script every day at midnight

[Timer]
OnCalendar=daily

[Install]
WantedBy=timers.target
</code></pre></div></div>

<p>After that you should reload daemon-service.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl daemon-reload
</code></pre></div></div>

<h3 id="manual-run-script-and-view-logs">Manual run script and view logs</h3>

<p>To run our systemd unit (or daemon) just run next command on a terminal:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl start backup
</code></pre></div></div>

<p>And anfter this command completed view logs by <code class="highlighter-rouge">journalctl -u backup</code></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Apr 14 11:07:48 ubuntu systemd[1]: Starting Backup PostgreSQL database...
Apr 14 11:07:48 ubuntu bash[234]: [backup][START] Start creating backup
Apr 14 11:08:48 ubuntu bash[234]: [backup][SUCCESS] Data backup success created
Apr 14 11:08:48 ubuntu bash[234]: [backup][SUCCESS] Config files success created
Apr 14 11:10:27 ubuntu bash[234]: [backup][SUCCESS] Data backup success copied
Apr 14 11:10:27 ubuntu bash[234]: [backup][COMPLETE] Backup success created
Apr 14 11:10:27 ubuntu systemd[1]: Started Backup PostgreSQL database.
</code></pre></div></div>

<h3 id="finish-preparations-and-check-the-results">Finish preparations and check the results</h3>

<p>Don’t forget setup <code class="highlighter-rouge">enable</code> flag on the timer for working them after reboot system.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl enable backup.timer
systemctl start backup.timer
</code></pre></div></div>

<p>And check active system timers with <code class="highlighter-rouge">systemctl list-timers</code>.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NEXT                         LEFT     LAST                         PASSED       UNIT                         ACTIVATES
Mon 2018-04-16 00:00:00 MSK  9h left  Sun 2018-04-15 00:00:52 MSK  14h ago      backup.timer                 backup.service
...

5 timers listed.
</code></pre></div></div>

<p>Ok, I just run a backup script two times on my database and have got two backups.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># borg list backup_server:/backups/db
ubuntu-2018-04-15T00:05:46.344337 Sun, 2018-04-15 00:05:28
ubuntu-2018-04-15T00:08:46.344337 Sun, 2018-04-15 00:08:47
</code></pre></div></div>

<p>Let’s see the information about second one.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># borg info backup_server:/backups/db::ubuntu-2018-04-15T00:08:46.344337
Name: ubuntu-2018-04-15T00:08:46.344337
Fingerprint: 19314fb992f83d9e746eda534d22fc8375a8d20c0cf8828a4353463574asdw
Hostname: ubuntu
Username: root
Time (start): Sun, 2018-04-15 00:08:47
Time (end):   Sun, 2018-04-15 00:08:47
Number of files: 2

                       Original size      Compressed size    Deduplicated size
This archive:                8.50 GB              8.50 GB                624 B
All archives:               17.00 GB             17.00 GB              6.64 GB

                       Unique chunks         Total chunks
Chunk index:                    2548                 6750
</code></pre></div></div>

<p>One dump file has a size of 8G, but repository using deduplication stores two ones with less disk usage space. All archives has reduce about 6,6G. Next command will agree this words</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>backup_server &gt;# du -hd0 /backups/db
6,2G    db
</code></pre></div></div>

<p>And at the end, I want to show the command that extracts (“restore”) backup from an archive repository to a local path.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mkdir old_data
cd old_data
borg extract backup_server:/backups/db::ubuntu-2018-04-15T00:08:46.344337
</code></pre></div></div>

<p>In conclucion I want to say that the Borg is a simple, reliable and secure tool to store your backup data. The data deduplication technique used makes Borg suitable for daily backups since only changes are stored. The authenticated encryption technique makes it suitable for backups to not fully trusted targets. And it has a simple interface to run with many parameters with borgmatic.</p>

<h2 id="additional-information">Additional information:</h2>

<p>This links might useful to get any additional information:</p>
<ul>
  <li><a href="http://slides.com/thomaswaldmann/borg">Borg by Thomas Waldmann</a></li>
  <li><a href="https://www.borgbackup.org/">BorgBackup Offsite</a></li>
  <li><a href="https://torsion.org/borgmatic/">borgmatic Offsite</a></li>
  <li><a href="https://www.reddit.com/r/linux/comments/69lm87/is_borg_backup_suitable_for_the_production/">Is Borg backup suitable for the production?</a></li>
</ul>


        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/blog/tags/postgres" class="page__taxonomy-item" rel="tag">postgres</a>
    
    </span>
  </p>




  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/blog/categories/linux" class="page__taxonomy-item" rel="tag">linux</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2018-04-15T00:00:00+03:00">April 15, 2018</time></p>
        
      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">Share on</h4>
  

  <a href="https://twitter.com/intent/tweet?via=gainanovrus&text=Create+daily+database+backups+with+Borg%20https%3A%2F%2Fgainanovrus.github.io%2Fblog%2Flinux%2Fdatabase-backup-with-borg%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fgainanovrus.github.io%2Fblog%2Flinux%2Fdatabase-backup-with-borg%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://plus.google.com/share?url=https%3A%2F%2Fgainanovrus.github.io%2Fblog%2Flinux%2Fdatabase-backup-with-borg%2F" class="btn btn--google-plus" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Google Plus"><i class="fab fa-fw fa-google-plus" aria-hidden="true"></i><span> Google+</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fgainanovrus.github.io%2Fblog%2Flinux%2Fdatabase-backup-with-borg%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/blog/linux/upgrade-centos/" class="pagination--pager" title="Upgrade CentOS 7.x to latest version
">Previous</a>
    
    
      <a href="/blog/travelling/journey-to-crimea/" class="pagination--pager" title="Программа максимум или как объехать и увидеть Крым за 5 дней!
">Next</a>
    
  </nav>

    </div>

    
      <div class="page__comments">
  
  
      <h4 class="page__comments-title">Leave a comment</h4>
      <section id="disqus_thread"></section>
    
</div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">You may also enjoy</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src=
          
            "/blog/assets/images/gitlab-ci/gitlab-ci-simple-pipeline.png"
          
          alt="">
      </div>
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/blog/devops/gitlab-ci-create-first-pipeline/" rel="permalink">GitLab CI/CD. Create simple pipeline
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  2 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">With using CI/CD pipelines in GitLab project you can easily build, test and deploy your code. This post will describe how to make it step by step.
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src=
          
            "/blog/assets/images/gitlab-ci/gitlab-ci-runner-centos.png"
          
          alt="">
      </div>
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/blog/devops/gitlab-ci-runner-install/" rel="permalink">GitLab CI/CD. Install and configure Runner
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  2 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">GitLab uses Runners for a running scripts that defined in your CI pipeline. A Runner is a daemon that hosted in your servers.  It waits commands from GitLab ...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src=
          
            "/blog/assets/images/gitlab-ci/gitlab-ci-devops.png"
          
          alt="">
      </div>
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/blog/devops/gitlab-ci-main-concepts/" rel="permalink">GitLab CI/CD. Main concepts and terms
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  2 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">Before we will create the first pipeline with GitLab CI we should understand what pipeline is it. I want to explain main terms in this post.
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src=
          
            "/blog/assets/images/gitlab-ci-teaser.png"
          
          alt="">
      </div>
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/blog/devops/gitlab-ci-main/" rel="permalink">GitLab CI/CD
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  less than 1 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">GitLab CI/CD takes many benefits for companies that want to automate software development workflow. I use it in my practice for a long time and want to docum...</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><input type="text" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
    <div id="results" class="results"></div></div>

      </div>
    

    <div class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    

    <li><a href="/blog/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2019 Ruslan Gainanov. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/blog/assets/js/main.min.js"></script>
  <script defer src="https://use.fontawesome.com/releases/v5.6.0/js/all.js" integrity="sha384-z9ZOvGHHo21RqN5De4rfJMoAxYpaVoiYhuJXPyVmSs8yn20IE3PmBM534CffwSJI" crossorigin="anonymous"></script>




<script src="/blog/assets/js/lunr/lunr.min.js"></script>
<script src="/blog/assets/js/lunr/lunr-store.js"></script>
<script src="/blog/assets/js/lunr/lunr-en.js"></script>




    
  <script>
    var disqus_config = function () {
      this.page.url = "https://gainanovrus.github.io/blog/linux/database-backup-with-borg/";  // Replace PAGE_URL with your page's canonical URL variable
      this.page.identifier = "/linux/database-backup-with-borg"; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    (function() { // DON'T EDIT BELOW THIS LINE
      var d = document, s = d.createElement('script');
      s.src = 'https://blog-w2w2-top.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


  



  </body>
</html>
