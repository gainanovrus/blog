<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.19.3 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>ESXi. The best way to build VPN tunnel with pfSense - GAINANOV.PRO</title>
<meta name="description" content="ESXi is good and reliable tool to run VMs on bare metal. It is configuring by webGUI. But the host with ESXi can be accessed only through NAT without any public IP or ports. This post shows how to create VPN tunnel with pfSense as VM on ESXi.">


  <meta name="author" content="Ruslan Gainanov">


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="GAINANOV.PRO">
<meta property="og:title" content="ESXi. The best way to build VPN tunnel with pfSense">
<meta property="og:url" content="https://gainanov.pro/eng-blog/sysad/esxi-pfsense-vpn/">


  <meta property="og:description" content="ESXi is good and reliable tool to run VMs on bare metal. It is configuring by webGUI. But the host with ESXi can be accessed only through NAT without any public IP or ports. This post shows how to create VPN tunnel with pfSense as VM on ESXi.">





  <meta name="twitter:site" content="@gainanovrus">
  <meta name="twitter:title" content="ESXi. The best way to build VPN tunnel with pfSense">
  <meta name="twitter:description" content="ESXi is good and reliable tool to run VMs on bare metal. It is configuring by webGUI. But the host with ESXi can be accessed only through NAT without any public IP or ports. This post shows how to create VPN tunnel with pfSense as VM on ESXi.">
  <meta name="twitter:url" content="https://gainanov.pro/eng-blog/sysad/esxi-pfsense-vpn/">

  
    <meta name="twitter:card" content="summary">
    
  

  



  <meta property="article:published_time" content="2019-10-24T00:00:00+03:00">



  <meta property="article:modified_time" content="2020-02-21T00:00:00+03:00">



  

  


<link rel="canonical" href="https://gainanov.pro/eng-blog/sysad/esxi-pfsense-vpn/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Ruslan Gainanov",
      "url": "https://gainanov.pro/eng-blog/",
      "sameAs": ["https://www.facebook.com/gainanovrus","https://twitter.com/gainanovrus","https://linkedin.com/in/gainanovrus"]
    
  }
</script>


  <meta name="google-site-verification" content="Wq8i7X_W6EpXbttUnWRWiok4EyvFVb-nyUaY_kDLDMc" />




  <meta name="yandex-verification" content="cfbcdd4107182b42">


<!-- end _includes/seo.html -->


<link href="/eng-blog/feed.xml" type="application/atom+xml" rel="alternate" title="GAINANOV.PRO Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/eng-blog/assets/css/main.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->


  
    <script src="/eng-blog/assets/js/buttons.js"></script>
  


    <!-- start custom head snippets -->
<!-- <link href="/assets/css/tagcloud04.css" rel="stylesheet" type="text/css"> -->
<link href="https://gainanov.pro/favicon.ico" rel="icon" type="image/x-icon" />

<!-- Add style to button that change languages (GR) -->
<link rel="stylesheet" href="/eng-blog/assets/css/language-button.css">

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-115465350-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-115465350-1');
</script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
   (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
   m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
   (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

   ym(57089593, "init", {
        clickmap:true,
        trackLinks:true,
        accurateTrackBounce:true
   });
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57089593" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    <div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        <!-- Change language button (GR) -->
        <a title="Change to RUS" class="language-button" style="margin-left: 0px;" onclick="location.pathname = '/rus-blog';" role="button"></a>
        <a class="site-title" href="/eng-blog/">GAINANOV.PRO</a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/eng-blog/categories/" >Categories</a>
            </li><li class="masthead__menu-item">
              <a href="/eng-blog/tags/" >Tags</a>
            </li><li class="masthead__menu-item">
              <a href="/eng-blog/portfolio/" >Portfolio</a>
            </li><li class="masthead__menu-item">
              <a href="/eng-blog/about/" >About me</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.99 16">
            <path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z" transform="translate(-.01)"></path>
          </svg>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      
        <img src="/eng-blog/assets/images/author-150x150.jpg" alt="Ruslan Gainanov" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Ruslan Gainanov</h3>
    
    
      <div class="author__bio" itemprop="description">
        <p>System &amp; Software engineer</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      

      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
            <li><a href="https://linkedin.com/in/gainanovrus" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span class="label">LinkedIn</span></a></li>
          
        
      

      
        <li>
          <a href="http://gainanov.pro" itemprop="url">
            <i class="fas fa-fw fa-link" aria-hidden="true"></i><span class="label">Website</span>
          </a>
        </li>
      

      
        <li>
          <a href="mailto:gromrx1@gmail.com">
            <meta itemprop="email" content="gromrx1@gmail.com" />
            <i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i><span class="label">Email</span>
          </a>
        </li>
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
      

      

    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="ESXi. The best way to build VPN tunnel with pfSense">
    <meta itemprop="description" content="ESXi is good and reliable tool to run VMs on bare metal. It is configuring by webGUI. But the host with ESXi can be accessed only through NAT without any public IP or ports. This post shows how to create VPN tunnel with pfSense as VM on ESXi.">
    <meta itemprop="datePublished" content="2019-10-24T00:00:00+03:00">
    <meta itemprop="dateModified" content="2020-02-21T00:00:00+03:00">

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">ESXi. The best way to build VPN tunnel with pfSense
</h1>
          
            <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  5 minute read

</p>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right ">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> On this page</h4></header>
              <ul class="toc__menu">
  <li><a href="#introduction">Introduction</a></li>
  <li><a href="#environment">Environment</a></li>
  <li><a href="#installation">Installation</a>
    <ul>
      <li><a href="#prepare-network">Prepare network</a></li>
      <li><a href="#upload-iso">Upload ISO</a></li>
      <li><a href="#create-vm-with-pfsense">Create VM with pfSense</a></li>
      <li><a href="#install-pfsense">Install pfSense</a></li>
      <li><a href="#configure-pfsense">Configure pfSense</a></li>
      <li><a href="#setup-openvpn">Setup OpenVPN</a></li>
      <li><a href="#setup-esxi-on-private-lan">Setup ESXi on private LAN</a></li>
      <li><a href="#enable-autorun-pfsense-vm">Enable autorun pfSense VM</a></li>
      <li><a href="#install-vm-tools">Install VM tools</a></li>
    </ul>
  </li>
  <li><a href="#some-notes">Some notes</a></li>
  <li><a href="#additional-information">Additional information</a></li>
</ul>

            </nav>
          </aside>
        
        <h2 id="introduction">Introduction</h2>

<p><a href="https://www.vmware.com/products/esxi-and-esx.html">ESXi</a> is a type-1 hypervisor, meaning it runs directly on system hardware without the need for an operating system (OS). Type-1 hypervisors are also referred to as bare-metal hypervisors because they run directly on hardware.</p>

<p>Also VMware vSphere Hypervisor is a free product and require a free license for the usage.</p>

<p><a href="https://www.pfsense.org/">pfSense</a> is a free and open source firewall and router that also features unified threat management, load balancing, multi WAN, and more.</p>

<h2 id="environment">Environment</h2>

<p>In this article I have next hardware and installed software on them:</p>
<ol>
  <li>Supermicro server with two network interfaces (1 - connected to Internet, 2 - to LAN)</li>
  <li>VMware ESXi 6.5 U3</li>
</ol>

<h2 id="installation">Installation</h2>

<p>So I have an installed ESXi hypervisor on my bare metal server.
I get access to ESXi through WebGUI by local IP that ESXI have got from DHCP Server.
I just open a browser and insert <code class="language-plaintext highlighter-rouge">10.16.65.12</code> in address line.</p>

<h3 id="prepare-network">Prepare network</h3>

<p>So after first boot I see a next window.</p>

<p><img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/001_not_join_to_improvement_programm.png" alt="001_not_join_to_improvement_programm" class="align-center" /></p>

<p>Set up a new vSwitch. It will use for access for created virtual machines.</p>

<p><img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/002_add_lan_vswitch.png" alt="002_add_lan_vswitch" class="align-center" /></p>

<p>Set an obvious name and select second network interface. In vmnic1 connected my laptop.</p>

<p><img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/003_create_vswitch_lan.png" alt="003_create_vswitch_lan" class="align-center" /></p>

<p>Now open <strong>Port groups</strong> tab.
<img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/004_add_new_portgroup.png" alt="004_add_new_portgroup" class="align-center" /></p>

<p>Add new port group that will used to connect our software firewall (pfSense).
Name it <strong>External</strong> as straight external network.</p>

<p><img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/005_create_external_port_group.png" alt="005_create_external_port_group" class="align-center" /></p>

<p>Retry it for creation <strong>Internal</strong> port group.
VMs connected to this port group has access to Internet only through a firewall.</p>

<p><img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/006_create_internal_port_group.png" alt="006_create_internal_port_group" class="align-center" /></p>

<p>The created port group by default can be removed.</p>

<p><img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/007_delete_default_port_group.png" alt="007_delete_default_port_group" class="align-center" /></p>

<p>Allow to delete it.
<img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/008_alllow_delete_default_port_group.png" alt="008_alllow_delete_default_port_group" class="align-center" /></p>

<p>View a result of these actions.
<img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/009_view_result_port_group_tab.png" alt="009_view_result_port_group_tab" class="align-center" /></p>

<p>Add new VMKernel interface.
<img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/010_add_new_vm_interface.png" alt="010_add_new_vm_interface" class="align-center" /></p>

<p>It needs to get access to ESXi WebGUI from our local network (<code class="language-plaintext highlighter-rouge">192.168.112.1/24</code>)
<img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/011_configure_new_vmnic.png" alt="011_configure_new_vmnic" class="align-center" /></p>

<p>After that we will have two management interfaces. An old one will be removed at the end.
<img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/012_view_results.png" alt="012_view_results" class="align-center" /></p>

<h3 id="upload-iso">Upload ISO</h3>

<p>Now we can prepare to make pfSense on ESXi. First of all add an installation ISO image.
<img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/013_open_datastore_page.png" alt="013_open_datastore_page" class="align-center" /></p>

<p>Create an <code class="language-plaintext highlighter-rouge">ISOs</code> directory.
<img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/014_create_iso_directory.png" alt="014_create_iso_directory" class="align-center" />
<img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/015_create_iso_directory.png" alt="015_create_iso_directory" class="align-center" /></p>

<p>Add a <a href="https://www.pfsense.org/download/">downloaded</a> ISO with pfSense.
<img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/016_add_pfsense_image.png" alt="016_add_pfsense_image" class="align-center" /></p>

<p>Wait some time. After that you will see the pfsense image in ESXi.
<img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/017_content_of_iso_directory.png" alt="017_content_of_iso_directory" class="align-center" /></p>

<h3 id="create-vm-with-pfsense">Create VM with pfSense</h3>

<p>Open <strong>Virtual machines</strong> page in ESXi. Click <strong>Create new VM</strong>.
<img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/018_open_vm_page.png" alt="018_open_vm_page" class="align-center" /></p>

<p>Yes, create a new virtual machine.
<img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/019_create_new_vm.png" alt="019_create_new_vm" class="align-center" /></p>

<p>Set name. Select type of VM.
<img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/020_set_name.png" alt="020_set_name" class="align-center" /></p>

<p>Select where VM will be installed.
<img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/021_vm_place_to_store_files.png" alt="021_vm_place_to_store_files" class="align-center" /></p>

<p>Add more space of VM disk. Add second network adapter. Join them with Internal and External PG.
<img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/022_configuration_vm.png" alt="022_configuration_vm" class="align-center" /></p>

<p>Select an installation ISO image uploaded earlier.
<img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/023_select_iso_image.png" alt="023_select_iso_image" class="align-center" /></p>

<p>Check the result of configuring VM.
<img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/024_check_result_config.png" alt="024_check_result_config" class="align-center" /></p>

<h3 id="install-pfsense">Install pfSense</h3>

<p>After that the VM has to be created. And we can click to button <strong>Power on</strong> for start installation.
<img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/025_run_created_vm.png" alt="025_run_created_vm" class="align-center" /></p>

<p>In many of screens I’ve just clicked <strong>Next</strong> and haven’t change anything.
<img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/026_accept_copyright.png" alt="026_accept_copyright" class="align-center" />
<img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/027_install_pfsense.png" alt="027_install_pfsense" class="align-center" />
<img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/028_use_default_keymap.png" alt="028_use_default_keymap" class="align-center" />
<img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/029_use_default_partition.png" alt="029_use_default_partition" class="align-center" />
<img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/030_wait_processing.png" alt="030_wait_processing" class="align-center" />
<img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/031_skip_manual.png" alt="031_skip_manual" class="align-center" />
<img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/032_reboot_system.png" alt="032_reboot_system" class="align-center" /></p>

<h3 id="configure-pfsense">Configure pfSense</h3>

<p>After reboot system will offer to setup network interfaces
<img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/033_setup_interfaces.png" alt="033_setup_interfaces" class="align-center" /></p>

<p>Open VM setting in ESXi to be right in this choose. And view network interface MACs.
<img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/034_view_mac_interfaces.png" alt="034_view_mac_interfaces" class="align-center" /></p>

<p>The WAN interface should be the virtual interface connected to External port group.
<img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/035_select_wan.png" alt="035_select_wan" class="align-center" /></p>

<p>Another interface will be LAN.
<img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/036_select_lan.png" alt="036_select_lan" class="align-center" /></p>

<p>Next see the results and continue the configuring in browser by <code class="language-plaintext highlighter-rouge">192.168.1.1</code>.
<img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/037_view_results.png" alt="037_view_results" class="align-center" /></p>

<p>Open browser and login in pfSense web configurator with default credentials (<code class="language-plaintext highlighter-rouge">admin</code>:<code class="language-plaintext highlighter-rouge">pfsense</code>)
<img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/038_pfsense_first_login.png" alt="038_pfsense_first_login" class="align-center" /></p>

<p>Skip welcome page. And read Netgear support information if you need.
<img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/039_view_welcome_page.png" alt="039_view_welcome_page" class="align-center" />
<img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/040_read_netgear_support.png" alt="040_read_netgear_support" class="align-center" /></p>

<p>Set hostname, NTP, timezone.
<img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/041_set_hostname.png" alt="041_set_hostname" class="align-center" />
<img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/042_set_ntp.png" alt="042_set_ntp" class="align-center" /></p>

<p>Configure WAN interface. My instance get IP by DHCP.
<img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/043_configure_wan.png" alt="043_configure_wan" class="align-center" /></p>

<p>Configure LAN network. Set a new network address <code class="language-plaintext highlighter-rouge">192.168.112.1/24</code>.
Remember WebGUI will have a new IP after reboot.
<img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/043_configure_lan.png" alt="043_configure_lan" class="align-center" /></p>

<p>Set new admin password.
<img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/045_set_admin_password.png" alt="045_set_admin_password" class="align-center" /></p>

<p>Click <strong>Reload</strong> button.
<img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/046_reload_system.png" alt="046_reload_system" class="align-center" />
<img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/047_finish_configuration.png" alt="047_finish_configuration" class="align-center" /></p>

<p>Open new browser tab with new WebGUI instance accessed by IP <code class="language-plaintext highlighter-rouge">192.168.112.1</code>.
<img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/048_dashboard_pfsense.png" alt="048_dashboard_pfsense" class="align-center" /></p>

<h3 id="setup-openvpn">Setup OpenVPN</h3>

<p>VMs and ESXi don’t have any public IP. But we can get full access to them if we will install OpenVPN.
I have another pfSense server with public IP. It will be <strong>OpenVPN Server</strong>.
This ESXi host and pfSense instance will connect to server and share their LAN (<code class="language-plaintext highlighter-rouge">192.168.112.1</code>).
We name pfSense that we configurating in this article as <strong>OpenVPN Client</strong>.
So for this purposes we need to do some manipulation with <strong>OpenVPN Server</strong>.</p>

<p>Open VPN page in WebGUI. Click <strong>Add</strong> button and create new OpenVPN Server.
Select <code class="language-plaintext highlighter-rouge">Peer to peer (shared key)</code> server mode. Set listen port <code class="language-plaintext highlighter-rouge">1201</code> (it can be any other).
Edit another options if it needs.
<img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/049_create_openvpnserver.png" alt="049_create_openvpnserver" class="align-center" /></p>

<p>After we click <strong>Save</strong> the shared key of the server will be generated.
Open created server.<br />
<img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/050_open_created_server.png" alt="050_open_created_server" class="align-center" /></p>

<p>Copy generated key. It will need to connect client to this server.
<img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/051_copy_shared_key.png" alt="051_copy_shared_key" class="align-center" /></p>

<p>Now open WebGUI of another pfSense that will <strong>OpenVPN Client</strong>. Open VPN page. Click <strong>Add</strong>.
<img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/052_add_new_client.png" alt="052_add_new_client" class="align-center" /></p>

<p>Setup OpenVPN client by my example. I highlight options that I modified.
<img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/053_create_openvpn_client.png" alt="053_create_openvpn_client" class="align-center" /></p>

<p>Click save and apply changes.
<img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/054_after_save_client.png" alt="054_after_save_client" class="align-center" /></p>

<p>Open status page of VPN connection
<img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/055_check_status_vpn.png" alt="055_check_status_vpn" class="align-center" /></p>

<p>The status will be <code class="language-plaintext highlighter-rouge">up</code>.
<img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/056_status_ok.png" alt="056_status_ok" class="align-center" /></p>

<p>Open Firewall configuration page. Follow to <strong>OpenVPN</strong> tab.
<img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/057_open_firewall_rules.png" alt="057_open_firewall_rules" class="align-center" /></p>

<p>Create new rule with allow traffic through this adapter to LAN net.
<img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/058_pass_traffic_by_openvpn.png" alt="058_pass_traffic_by_openvpn" class="align-center" /></p>

<p>Create another pass rule for LAN interface allows anything.
<img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/059_pass_traffic_by_lan.png" alt="059_pass_traffic_by_lan" class="align-center" /></p>

<p>Apply the changes.
<img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/060_apply_changes.png" alt="060_apply_changes" class="align-center" /></p>

<p>Now we can connect to pfSense (that configuring as OpenVPN client) by local IP (<code class="language-plaintext highlighter-rouge">192.168.112.1</code>).
ESXi server can be hosted in any place. If it connected to Internet also through NAT.
OpenVPN will auto connect to our public VPN server.</p>

<p>But to access to ESXi webGUI we should make some addition.</p>

<h3 id="setup-esxi-on-private-lan">Setup ESXi on private LAN</h3>

<p>We have an additional management virtual interface that connected to vSwitchLAN - <code class="language-plaintext highlighter-rouge">vmk1</code>. We made it before.
<img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/061_open_vmk1_interface.png" alt="061_open_vmk1_interface" class="align-center" /></p>

<p>Open the interface, and make sure that it has a right IP adress - <code class="language-plaintext highlighter-rouge">192.168.112.1</code>.
<img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/062_check_adapter_ip.png" alt="062_check_adapter_ip" class="align-center" /></p>

<p>Open TCP/IP stack tab. Select <strong>Default TCP/IP stack</strong>.
<img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/063_open_ip_stack_tab.png" alt="063_open_ip_stack_tab" class="align-center" /></p>

<p>Click <strong>Edit settings</strong> button.
<img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/064_click_edit_settings.png" alt="064_click_edit_settings" class="align-center" /></p>

<p>Manually configure it. Set pfSense IP as default gateway.
<img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/065_manually_configure.png" alt="065_manually_configure" class="align-center" /></p>

<p>We will lose the access to ESXi WebGUI. It’s OK. Just open it in new IP - <code class="language-plaintext highlighter-rouge">192.168.112.2</code>
<img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/066_open_esxi_webgui_by_lan_ip.png" alt="066_open_esxi_webgui_by_lan_ip" class="align-center" /></p>

<p>Open VMKernel NIC’s tab.
<img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/067_open_vmk_tab.png" alt="067_open_vmk_tab" class="align-center" /></p>

<p>Remove the management interface connected to External network to <code class="language-plaintext highlighter-rouge">vSwitch0</code>.
<img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/068_remove_external_mgmt_interface.png" alt="068_remove_external_mgmt_interface" class="align-center" /></p>

<p>Confirm remove.
<img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/069_confirm_remove.png" alt="069_confirm_remove" class="align-center" /></p>

<p>Now we have access only from OpenVPN tunnel or LAN network.
<img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/070_view_results.png" alt="070_view_results" class="align-center" /></p>

<p>Also we can delete unused <code class="language-plaintext highlighter-rouge">Management network</code> port group.
<img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/071_open_port_group_tab.png" alt="071_open_port_group_tab" class="align-center" />
<img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/072_remove_unused_mgmt_network.png" alt="072_remove_unused_mgmt_network" class="align-center" /></p>

<h3 id="enable-autorun-pfsense-vm">Enable autorun pfSense VM</h3>

<p>ESXi doesn’t run any VMs after power on by default. You should enable this manually.
It’s a simple. Open <strong>Virtual machines</strong> page and select <code class="language-plaintext highlighter-rouge">fw</code>.
<img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/075_select_fw_vm.png" alt="075_select_fw_vm" class="align-center" /></p>

<p>Enable autostart for selected VM.
<img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/076_enable_autostart.png" alt="076_enable_autostart" class="align-center" /></p>

<h3 id="install-vm-tools">Install VM tools</h3>

<p>ESXi will show you the notice message until you install VM tools.</p>
<blockquote>
  <p>VMware Tools is not installed in this virtual machine. VMware Tools allows detailed guest information to be displayed as well as allowing you to perform operations on the guest OS, e.g. graceful shutdown, reboot, etc. You should install VMware Tools.</p>
</blockquote>

<p><img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/077_view_notice_about_vm_tools.png" alt="077_view_notice_about_vm_tools" class="align-center" /></p>

<p>VM tools is very helpful instrument. And VMWare haven’t it for FreeBSD.
But exists <a href="https://docs.netgate.com/pfsense/en/latest/packages/open-vm-tools-package.html">Open VM tools package</a>.
It can be easily installed on pfSense <strong>Package manager</strong> page.
<img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/078_open_package_manager.png" alt="078_open_package_manager" class="align-center" /></p>

<p>Search and install Open VM tools.
<img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/079_search_open_vm_tools.png" alt="079_search_open_vm_tools" class="align-center" /></p>

<p>View success result of installation the package.
<img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/080_view_result_of_installation.png" alt="080_view_result_of_installation" class="align-center" /></p>

<p>Done! Now you can create any virtual machines on ESXi host and get full access to them by secure VPN tunnel :)</p>

<h2 id="some-notes">Some notes</h2>

<p>After I install <strong>Open VM Tools</strong> ESXi will show a warning message:</p>
<blockquote>
  <p>The configured guest OS (FreeBSD 12 or later versions (64-bit)) for this virtual machine does not match the guest that is currently running (FreeBSD 11 (64-bit)). You should specify the correct guest OS to allow for guest-specific optimizations.</p>
</blockquote>

<p><img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/081_view_warning_about_version_os.png" alt="081_view_warning_about_version_os" class="align-center" /></p>

<p>To avoid this just change the <strong>Guest OS Version</strong> to <code class="language-plaintext highlighter-rouge">FreeBSD 11 (64-bit)</code> and will be happy.
<img src="https://gainanov.pro/eng-blog/assets/images/installing-pfsense-on-esxi/082_change_guest_os_to_freebsd11.png" alt="082_change_guest_os_to_freebsd11" class="align-center" /></p>

<h2 id="additional-information">Additional information</h2>

<ul>
  <li><a href="https://www.vmware.com/content/dam/digitalmarketing/vmware/en/pdf/techpaper/virtual_networking_concepts.pdf">VMware Virtual Networking Concepts</a> -
  The information guide to VMware Networks.</li>
</ul>

        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/eng-blog/tags/esxi" class="page__taxonomy-item" rel="tag">esxi</a><span class="sep">, </span>
    
      
      
      <a href="/eng-blog/tags/openvpn" class="page__taxonomy-item" rel="tag">openvpn</a><span class="sep">, </span>
    
      
      
      <a href="/eng-blog/tags/pfsense" class="page__taxonomy-item" rel="tag">pfsense</a>
    
    </span>
  </p>




  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/eng-blog/categories/sysad" class="page__taxonomy-item" rel="tag">sysad</a>
    
    </span>
  </p>


        
  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2020-02-21">February 21, 2020</time></p>


      </footer>

      <section class="page__share">
  

  <a href="https://twitter.com/intent/tweet?via=gainanovrus&text=ESXi.+The+best+way+to+build+VPN+tunnel+with+pfSense%20https%3A%2F%2Fgainanov.pro%2Feng-blog%2Fsysad%2Fesxi-pfsense-vpn%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fgainanov.pro%2Feng-blog%2Fsysad%2Fesxi-pfsense-vpn%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fgainanov.pro%2Feng-blog%2Fsysad%2Fesxi-pfsense-vpn%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/eng-blog/linux/installing-jekyll-fedora/" class="pagination--pager" title="Installing Jekyll on Fedora 30
">Previous</a>
    
    
      <a href="/eng-blog/sysad/esxi-shell-commands/" class="pagination--pager" title="ESXi. The command line and shell magic
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">You May Also Enjoy</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/eng-blog/devops/dell-ansible-playbook/" rel="permalink">DELL. Configure Dell 10 gigabit switch with Ansible
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  8 minute read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">Use Ansible playbooks to easy configure Dell Networking OS9 system. The post contains many practical examples of using dellos9 modules
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/eng-blog/sysad/dell-switch-upgrade-firmware/" rel="permalink">DELL. Upgrade firmware on Dell S4048 switch (S-series, OS9)
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  3 minute read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">Instructions for upgrading the last firmware of Dell Networking system.
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/eng-blog/sysad/dell-smartassist-disable/" rel="permalink">DELL. Disabling SupportAssist on switch
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  3 minute read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">SupportAssist is a daemon for sending technical reports to Dell servers. It enables by default. Here we disable this unwanted feature (and may be unsecured).
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/eng-blog/sysad/dell-ssh-server-configure/" rel="permalink">DELL. Setup SSH server on OS9 switch (S4048 10G switch)
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  3 minute read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">Setup and configure ssh server on Dell Networking system with RSA and password authentication.
</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-copyright">&copy; 2020 Ruslan Gainanov. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/eng-blog/assets/js/main.min.js"></script>
  <script src="https://kit.fontawesome.com/4eee35f757.js"></script>




<script src="/eng-blog/assets/js/lunr/lunr.min.js"></script>
<script src="/eng-blog/assets/js/lunr/lunr-store.js"></script>
<script src="/eng-blog/assets/js/lunr/lunr-en.js"></script>







  </body>
</html>
